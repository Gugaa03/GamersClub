{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/guga0/Gamersclub/gamersclub-frontend/pages/Checkout.tsx"],"sourcesContent":["\"use client\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useAuth } from \"@/lib/AuthContext\";\r\nimport { useCart } from \"@/lib/CardContext\";\r\nimport { supabase } from \"@/lib/supabaseClient\";\r\n\r\nexport default function CheckoutPage() {\r\n  const { user } = useAuth();\r\n  const { cart, clearCart } = useCart();\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Garante que, se o cart estiver vazio, tente carregar do localStorage\r\n  useEffect(() => {\r\n    if (cart.length === 0) {\r\n      const savedCart = localStorage.getItem(\"cart\");\r\n      if (savedCart) {\r\n        const parsed = JSON.parse(savedCart);\r\n        clearCart(); // Limpa antes de adicionar\r\n        localStorage.setItem(\"cart\", JSON.stringify(parsed));\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  const totalPrice = cart.reduce((acc, g) => acc + (g.price || 0), 0);\r\n\r\n  const handlePurchase = async () => {\r\n    if (!user) return alert(\"Fa√ßa login primeiro!\");\r\n    if (!user.id) return alert(\"Usu√°rio sem ID definido.\");\r\n    if ((user.balance || 0) < totalPrice) return alert(\"Saldo insuficiente!\");\r\n\r\n    setLoading(true);\r\n\r\n    try {\r\n      // Registrar todas as compras\r\n      const inserts = cart.map((game) => ({\r\n        user_id: user.id, // deve existir na auth.users\r\n        game_id: game.id,\r\n        price: Number(game.price),\r\n      }));\r\n\r\n      const { error: purchaseError } = await supabase.from(\"purchases\").insert(inserts);\r\n      if (purchaseError) throw purchaseError;\r\n      console.log(\"‚úÖ Compras registradas no Supabase\", inserts);\r\n\r\n      // Atualiza saldo diretamente\r\n      const newBalance = (user.balance || 0) - totalPrice;\r\n      const { error: balanceError } = await supabase\r\n        .from(\"users\")\r\n        .update({ balance: newBalance })\r\n        .eq(\"id\", user.id);\r\n      if (balanceError) throw balanceError;\r\n      console.log(\"üí∞ Saldo atualizado:\", newBalance);\r\n\r\n      // Enviar email de recibo\r\n      try {\r\n        const response = await fetch(\"/api/send-email\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            recipient: user.email,\r\n            subject: \"Recibo da sua compra\",\r\n            html: `<h1>Obrigado pela compra!</h1>\r\n                   <p>Voc√™ comprou os seguintes jogos:</p>\r\n                   <ul>\r\n                     ${cart.map((g) => `<li>${g.title} - ‚Ç¨${g.price.toFixed(2)}</li>`).join(\"\")}\r\n                   </ul>\r\n                   <p>Total: ‚Ç¨${totalPrice.toFixed(2)}</p>`,\r\n          }),\r\n        });\r\n\r\n        const data = await response.json();\r\n        if (!response.ok) throw new Error(data.error || \"Erro ao enviar email\");\r\n        console.log(\"üìß Email de recibo enviado com sucesso:\", data);\r\n      } catch (emailErr) {\r\n        console.error(\"‚ùå Erro ao enviar email de recibo:\", emailErr);\r\n      }\r\n\r\n      // Limpa carrinho usando o m√©todo do contexto\r\n      clearCart();\r\n      alert(\"Compra realizada com sucesso!\");\r\n    } catch (err) {\r\n      console.error(\"‚ùå Erro ao registrar compra:\", err);\r\n      alert(\"Erro ao registrar a compra.\");\r\n    }\r\n\r\n    setLoading(false);\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-900 text-white p-8\">\r\n      <h1 className=\"text-3xl font-bold mb-6\">Checkout</h1>\r\n\r\n      <div className=\"space-y-4\">\r\n        {cart.length === 0 && <p className=\"text-gray-400\">Seu carrinho est√° vazio.</p>}\r\n        {cart.map((game) => (\r\n          <div\r\n            key={game.id}\r\n            className=\"flex items-center justify-between bg-gray-800 p-4 rounded-lg\"\r\n          >\r\n            <img src={game.image} className=\"w-16 h-16 object-cover rounded\" />\r\n            <span>{game.title}</span>\r\n            <span>‚Ç¨{game.price.toFixed(2)}</span>\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"mt-6 flex justify-between items-center\">\r\n        <span className=\"text-xl font-bold\">Total: ‚Ç¨{totalPrice.toFixed(2)}</span>\r\n        <button\r\n          onClick={handlePurchase}\r\n          disabled={loading || cart.length === 0}\r\n          className=\"bg-blue-600 hover:bg-blue-700 px-5 py-3 rounded-lg font-bold transition disabled:opacity-50\"\r\n        >\r\n          {loading ? \"Processando...\" : \"Comprar\"}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AACA;AACA;AACA;AACA;AAJA;;;;;;AAMe,SAAS;IACtB,MAAM,EAAE,IAAI,EAAE,GAAG,IAAA,uHAAO;IACxB,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,IAAA,uHAAO;IACnC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,+GAAQ,EAAC;IAEvC,uEAAuE;IACvE,IAAA,gHAAS,EAAC;QACR,IAAI,KAAK,MAAM,KAAK,GAAG;YACrB,MAAM,YAAY,aAAa,OAAO,CAAC;YACvC,IAAI,WAAW;gBACb,MAAM,SAAS,KAAK,KAAK,CAAC;gBAC1B,aAAa,2BAA2B;gBACxC,aAAa,OAAO,CAAC,QAAQ,KAAK,SAAS,CAAC;YAC9C;QACF;IACF,GAAG,EAAE;IAEL,MAAM,aAAa,KAAK,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,KAAK,IAAI,CAAC,GAAG;IAEjE,MAAM,iBAAiB;QACrB,IAAI,CAAC,MAAM,OAAO,MAAM;QACxB,IAAI,CAAC,KAAK,EAAE,EAAE,OAAO,MAAM;QAC3B,IAAI,CAAC,KAAK,OAAO,IAAI,CAAC,IAAI,YAAY,OAAO,MAAM;QAEnD,WAAW;QAEX,IAAI;YACF,6BAA6B;YAC7B,MAAM,UAAU,KAAK,GAAG,CAAC,CAAC,OAAS,CAAC;oBAClC,SAAS,KAAK,EAAE;oBAChB,SAAS,KAAK,EAAE;oBAChB,OAAO,OAAO,KAAK,KAAK;gBAC1B,CAAC;YAED,MAAM,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,0HAAQ,CAAC,IAAI,CAAC,aAAa,MAAM,CAAC;YACzE,IAAI,eAAe,MAAM;YACzB,QAAQ,GAAG,CAAC,qCAAqC;YAEjD,6BAA6B;YAC7B,MAAM,aAAa,CAAC,KAAK,OAAO,IAAI,CAAC,IAAI;YACzC,MAAM,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,0HAAQ,CAC3C,IAAI,CAAC,SACL,MAAM,CAAC;gBAAE,SAAS;YAAW,GAC7B,EAAE,CAAC,MAAM,KAAK,EAAE;YACnB,IAAI,cAAc,MAAM;YACxB,QAAQ,GAAG,CAAC,wBAAwB;YAEpC,yBAAyB;YACzB,IAAI;gBACF,MAAM,WAAW,MAAM,MAAM,mBAAmB;oBAC9C,QAAQ;oBACR,SAAS;wBAAE,gBAAgB;oBAAmB;oBAC9C,MAAM,KAAK,SAAS,CAAC;wBACnB,WAAW,KAAK,KAAK;wBACrB,SAAS;wBACT,MAAM,CAAC;;;qBAGE,EAAE,KAAK,GAAG,CAAC,CAAC,IAAM,CAAC,IAAI,EAAE,EAAE,KAAK,CAAC,IAAI,EAAE,EAAE,KAAK,CAAC,OAAO,CAAC,GAAG,KAAK,CAAC,EAAE,IAAI,CAAC,IAAI;;8BAElE,EAAE,WAAW,OAAO,CAAC,GAAG,IAAI,CAAC;oBACjD;gBACF;gBAEA,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,IAAI,CAAC,SAAS,EAAE,EAAE,MAAM,IAAI,MAAM,KAAK,KAAK,IAAI;gBAChD,QAAQ,GAAG,CAAC,2CAA2C;YACzD,EAAE,OAAO,UAAU;gBACjB,QAAQ,KAAK,CAAC,qCAAqC;YACrD;YAEA,6CAA6C;YAC7C;YACA,MAAM;QACR,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,MAAM;QACR;QAEA,WAAW;IACb;IAEA,qBACE,qKAAC;QAAI,WAAU;;0BACb,qKAAC;gBAAG,WAAU;0BAA0B;;;;;;0BAExC,qKAAC;gBAAI,WAAU;;oBACZ,KAAK,MAAM,KAAK,mBAAK,qKAAC;wBAAE,WAAU;kCAAgB;;;;;;oBAClD,KAAK,GAAG,CAAC,CAAC,qBACT,qKAAC;4BAEC,WAAU;;8CAEV,qKAAC;oCAAI,KAAK,KAAK,KAAK;oCAAE,WAAU;;;;;;8CAChC,qKAAC;8CAAM,KAAK,KAAK;;;;;;8CACjB,qKAAC;;wCAAK;wCAAE,KAAK,KAAK,CAAC,OAAO,CAAC;;;;;;;;2BALtB,KAAK,EAAE;;;;;;;;;;;0BAUlB,qKAAC;gBAAI,WAAU;;kCACb,qKAAC;wBAAK,WAAU;;4BAAoB;4BAAS,WAAW,OAAO,CAAC;;;;;;;kCAChE,qKAAC;wBACC,SAAS;wBACT,UAAU,WAAW,KAAK,MAAM,KAAK;wBACrC,WAAU;kCAET,UAAU,mBAAmB;;;;;;;;;;;;;;;;;;AAKxC","debugId":null}}]
}